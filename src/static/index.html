<!DOCTYPE html>
<html>
  <head>
    <title>Cockpit starting...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/patternfly.x1.css" rel="stylesheet">
    <style>
        /* Login page specific overrides */
        .login-pf {
            background: url("/static/images/bg-login.x0.jpg") no-repeat 50% 0;
            background-size: auto;
            background-color: #101010;
            color: #fff;
        }
        .message-icon {
            float: left;
            margin: 0 5px;
        }
        .pficon-layered {
            float: left;
            font-size: 200%;
        }
        .login-fatal {
            font-size: 130%;
        }
        .control-label {
            white-space: nowrap;
            font-size: 12px;
        }
        .waiting {
            background-color: transparent;
            background-image: url(/static/images/waiting.gif);
            background-repeat: no-repeat;
            background-position: 6px 9px;
            height: 28px;
            width: 28px;
        }
    </style>
    <script>
        var cockpit = { };
        var phantom_checkpoint = phantom_checkpoint || function () { };

        (function(cockpit) {

            /* Filled in by cockpit-ws handler */
            var initial_environment = cockpit_environment_info;

            function id(name) {
                return document.getElementById(name);
            }

            function fatal(msg) {
                if (window.console)
                    console.warn("fatal:", msg);

                id("login").style.display = 'none';
                id("login-details").style.display = 'none';
                id("login-fatal").style.display = 'block';
                id("login-fatal-message").appendChild(document.createTextNode(msg));
            }

            function requisites() {
                return ("WebSocket" in window || "MozWebSocket" in window) &&
                       ("XMLHttpRequest" in window) &&
                       ("localStorage" in window) &&
                       ("JSON" in window);
            }

            function trim(s) {
                return s.replace(/^\s+|\s+$/g, '');
            }

            function boot() {
                if (!requisites()) {
                    fatal("This web browser is too old to run Cockpit");
                    return;
                }

                /* Already logged in */
                if (initial_environment.user) {
                    shell(initial_environment);
                    return;
                }

                /* Show the login screen */
                document.title = initial_environment.hostname;
                var b = document.createElement("b");
                b.appendChild(document.createText(initial_environment.hostname));
                id("server-name").appendChild(b);
                id("login").style.visibility = 'visible';
                id("login-user-input").focus();
                id("login-user-input").addEventListener("keydown", function(e) {
                    $("#login-error-message").hide();
                    if (e.which == 13)
                        $("#login-password-input").focus();
                }, false);

                function call_login() {
                    var user = trim(id("#login-user-input").value);
                    if (user === "") {
                        var el = id("login-error-message");
                        el.visibility = 'block';
                        el.innerHTML = "User name cannot be empty";
                    } else {
                        login(user, id("login-password-input").value);
                    }
                }
                    
                id("login-password-input").addEventListener("keydown", function(e) {
                    id("login-error-message").style.display = 'none';
                    if (e.which == 13)
                        call_login();
                });
                id("login-buton").addEventListener("click", function(e) {
                    id("login-error-message").style.display = "none";
                    call_login();
                });
                phantom_checkpoint();
            }

            function utf8(str) {
                return unescape(encodeURIComponent(str));
            }

            function login(user, password) {
                id("login-button").setAttribute('disabled', "true");
                id("login-spinner").style.display = 'block';
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/login", true);
                xhr.setRequestHeader("Authorization", "Basic " + btoa(utf8(user + ":" + password)));
                xhr.onreadystatechange = function () {
                    if (xhr.readyState != 4) {
                        return;
                    } else if (xhr.status == 200) {
                        shell(JSON.parse(xhr.responseText));
                    } else if (xhr.status == 401) {
                        if (window.console)
                            console.log(xhr.statusText);
                        $("#login-error-message").show().text("Wrong username or password");
                    } else if (xhr.statusText) {
                        fatal(xhr.statusText);
                    } else {
                        fatal(xhr.status + " error");
                    }
                };       
                xhr.send();
            }

            function shell(environment) {
                var module = null;
                if (environment.localhost && environment.localhost.modules)
                    module = environment.localhost.modules["shell"];
                if (!module || !module.manifest) {
                    fatal("Cockpit not available: shell not installed correctly");
                    return;
                }
                if (module.checksum)
                    module.prefix = "/res/+" + module.checksum;
                else
                    module.prefix = "/res/+shell@localhost";

                function qualify(path) {
                    if (path.indexOf('/') === 0)
                        return path;
                    return module.prefix + '/' + path;
                }

                /* TODO: Compatibility ... rework these later */
                window.cockpitdyn_supported_languages = environment.localhost.languages;
                window.cockpitdyn_version = environment.localhost.version;
                window.cockpitdyn_build_info = environment.localhost.build_info;
                cockpit.environment = environment;
                cockpit.connection_config = environment;

                /* Simplistic module loader good enough for shell */
                if (module.manifest.css) {
                    var css = document.createElement("link");
                    css.setAttribute("rel", "stylesheet");
                    css.setAttribute("type", "text/css");
                    css.setAttribute("href", qualify(module.manifest.css));

                    var head = document.getElementsByTagName("head")[0];
                    head.appendChild(css);
                }

                var xhr = new XMLHTTPRequest();
                xhr.open("GET", qualify(module.manifest.html), true);
                xhr.responseType = "document";
                xhr.onreadystatechange = function(e) {
                    if (xhr.readyState != 4) {
                        return;
                    } else if (xhr.status == 200) {
                        document.body.removeAttribute("class");
                        document.body.innerHTML = xhr.responseText;

                        var i;
                        var scripts = module.manifest.scripts;
                        var length = scripts ? scripts.length : 0;
                        for (i = 0; i < length; i++) {
                            var script = document.createElement("script");
                            script.async = false;
                            script.src = qualify(scripts[i]);
                            document.head.appendChild(script);
                        }
                    } else {
                        if (window.console)
                            console.log(xhr.statusText);
                        fatal("Cockpit not available: cannot load shell");
                    }
                    phantom_checkpoint();
                };
                xhr.send();
            }

        
            window.onload = boot;
        })(cockpit);
    </script>
  </head>
  <body class="login-pf">
    <span id="badge">
      <img src="/static/images/logo.v0.png" alt="" />
    </span>
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div id="brand">
            <img src="/static/images/brand-large.v0.png">
          </div><!--/#brand-->
        </div><!--/.col-*-->

        <div id="login" class="col-sm-7 col-md-6 col-lg-5 login-area" style="visibility: hidden;">
          <div class="form-horizontal" role="form">
            <div class="form-group login-form">
              <label for="login-user-input" class="col-sm-2 col-md-2 control-label">User name</label>
              <div class="col-sm-10 col-md-10">
                <input type="text" class="form-control" id="login-user-input" tabindex="1">
              </div>
            </div>
            <div class="form-group login-form">
              <label for="login-password-input" class="col-sm-2 col-md-2 control-label">Password</label>
              <div class="col-sm-10 col-md-10">
                <input type="password" class="form-control" id="login-password-input" tabindex="2">
              </div>
            </div>
            <div class="form-group login-form">
              <div class=" col-xs-12 col-sm-offset-2 col-sm-6">
                <span class="help-block" id="login-error-message"></span>
              </div>
              <div class="col-sm-1">
                <div class="waiting col-xs-15" id="login-spinner" style="display: none">
                </div>
              </div>
              <div class="col-sm-3">
                <button class="btn btn-primary btn-lg col-xs-12" id="login-button" tabindex="3">
                  Log In
                </button>
              </div>
            </div>
          </div>
        </div><!--/.col-*-->

        <div class="col-sm-5 col-md-6 col-lg-7 details" id="login-details">
          <p>
            <label id="server-name" class="control-label">Server: </label>
            <div class="message-icon">
              <span class="pficon-layered">
                <span class="pficon pficon-warning-triangle"></span>
                <span class="pficon pficon-warning-exclamation"></span>
              </span>
            </div>
            This is pre-release software. Only use it on a system that you are willing to lose.
          </p>
        </div><!--/.col-*-->

        <div id="login-fatal" style="display: none;">
          <div class="message-icon">
            <span class="pficon-layered">
              <span class="pficon pficon-error-octagon"></span>
              <span class="pficon pficon-warning-exclamation"></span>
            </span>
          </div>
          <span id="login-fatal-message"></span>
        </div>

      </div><!--/.row-->
    </div><!--/.container-->
  </body>
</html>
